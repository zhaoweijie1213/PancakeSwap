# 价格预测接口

## 1.当前回合（Current Round）

当前回合信息

赔率（上升） = 总奖池金额 / 上升池金额 
赔率（下降） = 总奖池金额 / 下降池金额 

**请求示例：**

```json
{
  "event": "currentRound"
}
```

**ws** 

**返回结果：**

|    字段名    |      类型      | 说明                                                         |
| :----------: | :------------: | :----------------------------------------------------------- |
|      Id      |      int       | 回合编号                                                     |
|  lockPrice   | decimal(20, 8) | 锁仓价格（判断涨跌的起点）                                   |
| currentPrice | decimal(20, 8) | 当前价格                                                     |
| totalAmount  | decimal(20, 8) | 总下注金额                                                   |
|   upAmount   | decimal(20, 8) | 押“上升”的总金额                                             |
|  downAmount  | decimal(20, 8) | 押“下降”的总金额                                             |
| rewardAmount | decimal(20, 8) | 可分配的奖金池（扣除手续费后）                               |
|   endTime    |   timestamp    | 回合结束时间                                                 |
|    oddsUp    |     float      | 上升赔率 (保留两位小数)                                      |
|   oddsDown   |     float      | 下降赔率(保留两位小数)                                       |
|    status    |      enum      | 回合状态：<br />`upcoming`-即将开始 <br />`live` -进行中<br />`locked`-已锁定<br />`ended`-已结束 |

**返回示例：**

```json
{
  "id": 357690,
  "lockPrice": "308.85000000",
  "currentPrice": "309.12500000",
  "totalAmount": "2500.00000000",
  "upAmount": "1400.00000000",
  "downAmount": "1100.00000000",
  "rewardAmount": "2425.00000000",
  "endTime": 1710001234,
  "status": "live",
  "oddsUp": "1.73214286",
  "oddsDown": "2.20454545"
}
```

## 2.回合结束（Round ended）

通知回合结束-广播消息

**ws**

**返回结果：**

| 字段名 | 类型 | 说明     |
| :----- | :--- | -------- |
| Id     | int  | 回合编号 |



## 2.历史回合

**GET** `/api/rounds/history`

返回最近三回合的数据

**返回结果：**

|    字段名    |      类型      | 说明                                                         |
| :----------: | :------------: | :----------------------------------------------------------- |
|      Id      |      int       | 回合编号                                                     |
|  lockPrice   | decimal(20, 8) | 锁仓价格（判断涨跌的起点）                                   |
|  closePrice  | decimal(20, 8) | 结束价格                                                     |
| totalAmount  | decimal(20, 8) | 总下注金额                                                   |
|   upAmount   | decimal(20, 8) | 押“上升”的总金额                                             |
|  downAmount  | decimal(20, 8) | 押“下降”的总金额                                             |
| rewardAmount | decimal(20, 8) | 可分配的奖金池（扣除手续费后）                               |
|   endTime    |   timestamp    | 回合结束时间                                                 |
|    oddsUp    |     float      | 上升赔率 (保留两位小数)                                      |
|   oddsDown   |     float      | 下降赔率(保留两位小数)                                       |
|    status    |      enum      | 回合状态：<br />`upcoming`-即将开始 <br />`live` -进行中<br />`locked`-已锁定<br />`ended`-已结束 |

**返回示例：**

```json
[
  {
    "id": 357689,
    "lockPrice": "308.85000000",
    "closePrice": "309.75000000",
    "totalAmount": "1800.00000000",
    "upAmount": "1000.00000000",
    "downAmount": "800.00000000",
    "rewardAmount": "1746.00000000",
    "endTime": 1709999999,
    "status": "ended",
    "oddsUp": "1.746",
    "oddsDown": "2.1825"
  }
]
```

## 3.后续回合接口

**GET** `/api/rounds/upcoming`

**返回结果：**

即将开始的2回合数据

**Upcoming Round**

| 字段名    | 类型      | 说明         |
| --------- | --------- | ------------ |
| Id        | int       | 回合编号     |
| startTime | timestamp | 回合结束时间 |
| endTime   | timestamp | 回合结束时间 |

**返回示例：**

```json
[
    {
      "id": 357691,
      "startTime": 1710001245,
      "endTime": 1710001545
    },
    {
      "id": 357692,
      "startTime": 1710001548,
      "endTime": 1710001608
    }
]
```



## 4.Chainlink图表

返回最近10分钟的数据

每个坐标时间间隔为20秒

**请求示例：**

```json
{
  "event": "chartData"
}
```

**ws**

**返回结果：**

| 字段名        | 类型      | 说明                   |
| ------------- | --------- | ---------------------- |
| originalXData | string[]  | X轴数据:时间数组       |
| seriesData    | decimal[] | Y轴数据(精确到4位小数) |

**返回示例：**

```json
{
  "originalXData": [
    "12:00:00", "12:00:20", "12:00:40", "12:01:00"
  ],
  "seriesData": [
    308.7901, 308.8250, 308.6978, 308.7123
  ]
}
```



## 5.用户历史预测数据

### 📦 模式一：mode = `round`（回合记录）

**GET** `/api/user/predictions/round`

**请求参数：**

| 字段名   | 类型   | 说明                                                         |
| -------- | ------ | ------------------------------------------------------------ |
| mode     | enum   | `mode=round`：返回每轮下注详情<br />`mode=pnl`：返回每轮盈亏数据（含历史总盈亏） |
| symbol   | string | 币种，默认 `BNBUSD`                                          |
| status   | enum   | all（所有）/claimed（已领取）/unclaimed（未领取）            |
| page     | int    | 分页页码，默认 1                                             |
| pageSize | int    | 每页数量，默认 10                                            |

**请求示例：**

```shell
GET /api/user/predictions/round?symbol=BNBUSD&page=1&pageSize=10&status=unclaimed
```

**返回结果：**

| 字段名     | 类型   | 说明                     | 示例值     |
| ---------- | ------ | ------------------------ | ---------- |
| `mode`     | string | 当前模式，固定为 `round` | `"round"`  |
| `symbol`   | string | 币种交易                 | `"BNBUSD"` |
| `page`     | int    | 当前页码                 | `1`        |
| `pageSize` | int    | 每页记录数               | `10`       |
| `total`    | int    | 总记录数                 | `2`        |
| `data`     | array  | 用户预测记录数组         | `[...]`    |

**🔍 `data[]` 每一条下注记录字段：**

|    字段名    |  类型   |                   说明                   |    示例值     |
| :----------: | :-----: | :--------------------------------------: | :-----------: |
|     `id`     |   int   |                 回合编号                 |    `12345`    |
|  `position`  | string  |       用户下注方向：`up` 或 `down`       |    `"up"`     |
|   `amount`   | string  |   用户下注金额，使用字符串返回 decimal   |   `"50.00"`   |
| `lockPrice`  | string  |          锁定价格（开始时价格）          |  `"308.10"`   |
| `closePrice` | string  |          收盘价格（结束时价格）          |  `"310.50"`   |
|   `reward`   | string  |  用户可获得的奖励金额（或为 `"0.00"`）   |   `"92.30"`   |
|  `claimed`   | boolean |              是否已领取奖励              |    `false`    |
|   `result`   | string  |   用户下注结果：`win`、`lose`、`draw`    |    `"win"`    |
|   `status`   | string  | 状态标识：`claimed`、`unclaimed`、`lost` | `"unclaimed"` |

**返回示例：**

```json
{
  "mode": "round",
  "symbol": "BNBUSD",
  "page": 1,
  "pageSize": 10,
  "total": 2,
  "data": [
    {
      "id": 12345,
      "position": "up",
      "amount": "50.00",
      "lockPrice": "308.10",
      "closePrice": "310.50",
      "reward": "92.30",
      "claimed": false,
      "result": "win",
      "status": "unclaimed"
    }
  ]
}
```




------

### 💰 模式二：mode = `pnl`（盈亏统计 返回每轮盈亏数据 含历史总盈亏）

**GET** `/api/user/predictions/pnl`

**请求参数：**

| 字段名   | 类型   | 说明                                              |
| -------- | ------ | ------------------------------------------------- |
| symbol   | string | 币种，默认 `BNBUSD`                               |
| status   | enum   | all（所有）/claimed（已领取）/unclaimed（未领取） |
| page     | int    | 分页页码，默认 1                                  |
| pageSize | int    | 每页数量，默认 10                                 |

**请求示例：**

```shell
GET /api/user/predictions/pnl?symbol=BNBUSD&page=1&pageSize=10
```

**返回结果：**

| 字段名    | 类型          | 说明                   | 示例值          |
| --------- | ------------- | :--------------------- | --------------- |
| `mode`    | string        | 当前模式，固定为 `pnl` | `"pnl"`         |
| `address` | string        | 用户的钱包地址         | `"0xAbC123..."` |
| `symbol`  | string        | 币种交易对             | `"BNBUSD"`      |
| `summary` | summary       | 总盈亏                 | `{...}`         |
| `data`    | history array | 每回合盈亏详情         | `[...]`         |

**summary：**

| 字段名         | 类型   | 说明                            | 示例值     |
| -------------- | ------ | ------------------------------- | ---------- |
| `totalRounds`  | int    | 总参与回合数                    | `10`       |
| `totalWagered` | string | 总下注金额                      | `"250.00"` |
| `totalClaimed` | string | 总领取奖金金额                  | `"410.20"` |
| `totalProfit`  | string | 盈亏总额（= claimed - wagered） | `"160.20"` |

**history:**

| 字段名    | 类型    | 说明                                   | 示例值    |
| --------- | ------- | -------------------------------------- | --------- |
| id        | int     | 回合编号                               | `12345`   |
| `profit`  | string  | 盈亏金额（正数代表盈利，负数代表亏损） | `"42.30"` |
| `result`  | string  | 结果：`win` / `lose` / `draw`          | `"win"`   |
| `claimed` | boolean | 是否已领取奖金                         | `true`    |

**返回示例：**

```json
{
  "mode": "pnl",
  "address": "0xAbC123...",
  "symbol": "BNBUSD",
  "summary": {
    "totalRounds": 10,
    "totalWagered": "250.00",
    "totalClaimed": "410.20",
    "totalProfit": "160.20"
  },
  "data": [
    {
      "id": 12345,
      "profit": "42.30",
      "result": "win",
      "claimed": true
    }
  ]
}
```



## 6.排行榜

排行榜界面，这个排行榜用于展示用户的战绩排名，支持按多个维度排序，比如：

- 回合数（Rounds Played）
- 净收益（Net Winnings）
- 总下注（Total BNB）
- 胜率（Win Rate）

#### 排行榜

**GET** `/api/leaderboard/list`

**请求参数：**

**请求参数说明：**

| 参数名     | 类型   | 必填 | 默认值   | 描述                                                     |
| ---------- | ------ | ---- | -------- | -------------------------------------------------------- |
| `network`  | string | 否   | `bsc`    | 区块链网络（如：bsc, arbitrum, polygon 等）              |
| `symbol`   | string | 否   | `BNBUSD` | 币种对，例如 BNBUSD、BTCUSD                              |
| `rankBy`   | string | 否   | `rounds` | 排名方式：`rounds`, `netWinnings`, `totalBnb`, `winRate` |
| address    | string | 否   | `null`   | 钱包地址                                                 |
| `page`     | int    | 否   | `1`      | 当前页码                                                 |
| `pageSize` | int    | 否   | `10`     | 每页返回多少条数据                                       |

**示例请求：**

```shell
GET /api/leaderboard/list?network=bsc&symbol=BNBUSD&rankBy=netWinnings&page=1&pageSize=10
```

**返回字段说明：**

返回一个包含分页数据的排行榜数组，每个元素是一个用户的汇总统计

| 字段名           | 类型   | 描述                              | 示例值        |
| ---------------- | ------ | --------------------------------- | ------------- |
| `rank`           | int    | 当前用户的排名位置                | `1`           |
| name             | string | 用户名称                          | Mah21         |
| `address`        | string | 用户钱包地址                      | `0xd8...8e6c` |
| `netWinnings`    | string | 用户的净收益（单位：BNB）         | `233.493245`  |
| `netWinningsUSD` | string | 用户净收益的美元估值              | `142061.96`   |
| `winRate`        | string | 胜率百分比（保留两位小数）        | `52.97%`      |
| `roundsPlayed`   | int    | 总共参与的回合数                  | `75474`       |
| `roundsWon`      | int    | 赢的回合数                        | `39981`       |
| `totalBnb`       | string | 总下注金额（单位：BNB，可选字段） | `1023.589`    |

 `netWinnings = 总领奖收益 - 总下注金额`

**示例响应（JSON）**

```json
{
  "network": "bsc",
  "symbol": "BNBUSD",
  "rankBy": "netWinnings",
  "page": 1,
  "pageSize": 10,
  "total": 100,
  "data": [
    {
      "rank": 1,
      "address": "0xd8...8e6c",
      "netWinnings": "233.493245",
      "netWinningsUSD": "142061.96",
      "winRate": "52.97%",
      "roundsWon": 39981,
      "roundsPlayed": 75474,
      "totalBnb": "1023.58"
    },
    {
      "rank": 2,
      "address": "0x9f...bade",
      "netWinnings": "-112.13648",
      "netWinningsUSD": "-68226.08",
      "winRate": "50.7%",
      "roundsWon": 33677,
      "roundsPlayed": 66426,
      "totalBnb": "958.12"
    }
  ]
}
```

**排序逻辑说明（rankBy）**

|    参数值     |    排序字段    |        说明        |
| :-----------: | :------------: | :----------------: |
|   `rounds`    | `roundsPlayed` | 总参与回合从多到少 |
| `netWinnings` | `netWinnings`  |   净收益从高到低   |
|  `totalBnb`   |   `totalBnb`   |   总下注从多到少   |
|   `winRate`   |   `winRate`    |    胜率从高到低    |

#### 用户详情

**GET** `/api/leaderboard/userDetail`

 **用户总统计数据：**

- 钱包地址（脱敏）
- 净收益（BNB + USD估值）
- 胜率（Win Rate）
- 赢的回合数
- 总参与回合数

**最近 5 次下注记录（Last 5 Bets）：**

- 回合编号
- 方向（UP / DOWN）
- 盈亏金额（BNB + 美元估值）

------

**🔍 请求参数说明**

| 参数名    | 类型   | 是否必填 | 描述                        |
| --------- | ------ | -------- | --------------------------- |
| `address` | string | 是       | 用户钱包地址（如 0x123...） |
| `symbol`  | string | 否       | 币种对（默认 `BNBUSD`）     |
| `network` | string | 否       | 区块链网络（默认 `bsc`）    |

```shell
GET /api/leaderboard/user-detail?address=0xd8...8e6c&symbol=BNBUSD&network=bsc
```



------

**✅ 返回字段说明**

**基础信息（用户统计）**

| 字段名           | 类型   | 描述           | 示例值          |
| ---------------- | ------ | -------------- | --------------- |
| `address`        | string | 钱包地址       | `"0xd8...8e6c"` |
| `netWinnings`    | string | 净收益 BNB     | `"233.493245"`  |
| `netWinningsUSD` | string | 净收益 USD估值 | `"141604.31"`   |
| `winRate`        | string | 胜率（百分比） | `"52.97%"`      |
| `roundsPlayed`   | int    | 总参与回合数   | `75474`         |
| `roundsWon`      | int    | 赢的回合数     | `39981`         |
| bets             | Bet[]  | 下注记录       |                 |

**Bet类型说明**

| 字段名      | 类型   | 描述                         | 示例值        |
| ----------- | ------ | ---------------------------- | ------------- |
| `id`        | int    | 回合编号                     | `357689`      |
| `direction` | string | 用户下注方向：`up` 或 `down` | `"up"`        |
| `result`    | string | 盈亏结果：`win` / `lose`     | `"win"`       |
| `pnl`       | string | 盈亏金额（BNB，可能为负）    | `"+0.028275"` |
| `pnlUSD`    | string | 盈亏金额的美元估值           | `"17.12"`     |

------

**示例响应 JSON**

```json
{
  "address": "0xd8...8e6c",
  "netWinnings": "233.493245",
  "netWinningsUSD": "141604.31",
  "winRate": "52.97%",
  "roundsWon": 39981,
  "roundsPlayed": 75474,
  "last5Bets": [
    {
      "id": 357689,
      "direction": "up",
      "result": "win",
      "pnl": "0.028275",
      "pnlUSD": "17.12"
    },
    {
      "id": 357688,
      "direction": "up",
      "result": "win",
      "pnl": "0.044608",
      "pnlUSD": "27.05"
    },
    {
      "id": 357686,
      "direction": "up",
      "result": "lose",
      "pnl": "-0.0752",
      "pnlUSD": "-45.61"
    },
    {
      "id": 357685,
      "direction": "down",
      "result": "lose",
      "pnl": "-0.1044",
      "pnlUSD": "-63.31"
    },
    {
      "id": 357682,
      "direction": "down",
      "result": "win",
      "pnl": "0.218578",
      "pnlUSD": "132.56"
    }
  ]
}
```
